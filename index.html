<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Financial Assistant</title>
<link rel="stylesheet" href="style.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/11.1.1/marked.min.js"></script>
</head>
<body>
<div class="container">
  <div class="header-section">
    <h1>Chat Tributo</h1>
    <p>Seu guia para o Novo Imposto de Renda</p>
  </div>
  
  <div id="messages" class="chat-container"></div>
  
  <div class="footer-section">
    <div class="input-row">
      <input id="userInput" type="text" placeholder="How can I help with your finances today?" />
      <button id="sendButton">Send</button>
    </div>
  </div>
</div>

<script>
const ENDPOINT = "https://enough-blatantly-whale.ngrok-free.app/chat";
const messagesDiv = document.getElementById('messages');
const inputField = document.getElementById('userInput');
const sendButton = document.getElementById('sendButton');

function parseMarkdown(text) {
  return marked.parse(text);
}

function addMessage(text, who = 'bot') {
  const wrapper = document.createElement('div');
  wrapper.className = `message-wrapper ${who}`;
  
  const icon = document.createElement('div');
  icon.className = 'msg-icon';
  icon.textContent = who === 'user' ? 'ğŸ‘¤' : 'ğŸ’°';
  
  const body = document.createElement('div');
  body.className = 'msg-body';
  
  const name = document.createElement('div');
  name.className = 'msg-name';
  name.textContent = who === 'user' ? 'VocÃª' : 'Chat Tributo';
  
  const textDiv = document.createElement('div');
  textDiv.className = 'msg-text';
  textDiv.innerHTML = who === 'bot' ? parseMarkdown(text) : text;
  
  body.appendChild(name);
  body.appendChild(textDiv);
  wrapper.appendChild(icon);
  wrapper.appendChild(body);
  messagesDiv.appendChild(wrapper);
  messagesDiv.scrollTop = messagesDiv.scrollHeight;

  return textDiv;
}

function sendMessage() {
  const message = inputField.value.trim();
  if (!message) return;

  addMessage(message, 'user');
  inputField.value = '';
  const botDiv = addMessage('...', 'bot');

  // Build query params (EventSource only allows GET)
  const params = new URLSearchParams({
    message,
    stream: true,
    language: "Portuguese",
    session_id: "default"
  });

  // Close any previous EventSource before starting a new one
  if (window.currentSource) window.currentSource.close();

  const source = new EventSource(`${ENDPOINT}?${params.toString()}`);
  window.currentSource = source;

  let accumulated = '';

  source.onmessage = (event) => {
    if (event.data === '[DONE]') {
      source.close();
      return;
    }
    accumulated += event.data;
    botDiv.innerHTML = parseMarkdown(accumulated);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
  };

  source.onerror = (err) => {
    console.error('SSE error:', err);
    botDiv.innerHTML = parseMarkdown("âš ï¸ Connection lost or streaming error.");
    source.close();
  };
}

sendButton.addEventListener('click', sendMessage);
inputField.addEventListener('keypress', e => { if (e.key === 'Enter') sendMessage(); });
</script>

</body>
</html>